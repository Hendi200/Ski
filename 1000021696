<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GIPFEL — Ski Tracker</title>

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#080e14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GIPFEL">
<link rel="apple-touch-icon" href="/icon-192.png">

<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;900&family=DM+Mono:wght@300;400;500&display=swap');

:root {
  --bg: #080e14;
  --card: #111d2b;
  --border: rgba(255,255,255,0.07);
  --border-lit: rgba(255,255,255,0.16);
  --snow: #eef4ff;
  --ice: #7dd3e8;
  --glacier: #34b4d4;
  --summit: #ff6b35;
  --green: #4ade80;
  --yellow: #fbbf24;
  --red: #f87171;
  --text-dim: rgba(238,244,255,0.38);
  --text-mid: rgba(238,244,255,0.65);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; }
body { background:var(--bg); color:var(--snow); font-family:'DM Mono',monospace; font-size:13px; }

.screen { position:fixed; inset:0; display:flex; flex-direction:column; overflow:hidden; transition:opacity 0.35s, transform 0.35s; }
.screen.hidden { opacity:0; pointer-events:none; transform:scale(0.97); }

/* ── ONBOARDING ── */
#screenOnboard {
  align-items:center; justify-content:center; text-align:center;
  background:radial-gradient(ellipse at 50% 20%, #0e2d4a 0%, #080e14 65%);
  padding:32px 28px;
}
.ob-mountains { position:absolute; bottom:0; left:0; right:0; height:55%; pointer-events:none; }
.ob-title { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:80px; letter-spacing:-3px; line-height:0.88; color:white; position:relative; z-index:2; }
.ob-title em { color:var(--glacier); font-style:normal; }
.ob-sub { font-size:10px; letter-spacing:6px; text-transform:uppercase; color:var(--text-dim); margin:14px 0 36px; position:relative; z-index:2; }
.feature-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; max-width:340px; margin-bottom:32px; position:relative; z-index:2; }
.feat { background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:14px; padding:14px 12px; text-align:left; }
.feat-icon { font-size:24px; margin-bottom:6px; }
.feat-name { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:700; color:var(--snow); }
.feat-desc { font-size:9px; color:var(--text-dim); margin-top:2px; line-height:1.5; }
.btn-launch { width:100%; max-width:300px; padding:20px 0; background:var(--summit); border:none; border-radius:16px; font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:26px; letter-spacing:3px; color:white; cursor:pointer; box-shadow:0 8px 40px rgba(255,107,53,0.4), inset 0 1px 0 rgba(255,255,255,0.2); position:relative; z-index:2; transition:transform 0.15s; }
.btn-launch:active { transform:scale(0.96); }

/* Install banner */
.install-banner { display:none; position:relative; z-index:2; margin-top:14px; background:rgba(52,180,212,0.12); border:1px solid rgba(52,180,212,0.25); border-radius:12px; padding:10px 16px; font-size:11px; color:var(--ice); letter-spacing:1px; cursor:pointer; }
.install-banner.show { display:block; }

/* ── LIVE ── */
#screenLive { background:var(--bg); }
.live-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
.live-logo { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:24px; letter-spacing:1px; }
.live-logo span { color:var(--glacier); }
.pill { display:flex; align-items:center; gap:5px; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:5px 11px; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--text-mid); }
.dot { width:6px; height:6px; border-radius:50%; background:#333; flex-shrink:0; }
.dot.gps { background:var(--green); box-shadow:0 0 6px var(--green); animation:blink 1.5s infinite; }
.dot.warn { background:var(--yellow); box-shadow:0 0 6px var(--yellow); animation:blink 0.8s infinite; }
.dot.rec { background:var(--red); animation:blink 0.7s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

.live-scroll { flex:1; overflow-y:auto; padding:14px 14px 110px; -webkit-overflow-scrolling:touch; }

.speed-block { background:linear-gradient(150deg, #0d2035 0%, #080e14 100%); border:1px solid var(--border); border-radius:20px; padding:22px 22px 16px; margin-bottom:12px; position:relative; overflow:hidden; }
.speed-block::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 50% 0%, rgba(0,212,255,0.07) 0%, transparent 65%); pointer-events:none; }
.speed-label { font-size:9px; letter-spacing:5px; text-transform:uppercase; color:var(--text-dim); margin-bottom:4px; }
.speed-row { display:flex; align-items:flex-end; gap:10px; }
.speed-num { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:96px; line-height:0.9; color:white; text-shadow:0 0 50px rgba(0,212,255,0.45); transition:color 0.3s; min-width:170px; }
.speed-sidestack { padding-bottom:8px; }
.speed-unit { font-size:14px; color:var(--ice); letter-spacing:2px; display:block; }
.speed-maxlive { font-size:10px; color:var(--text-dim); margin-top:6px; }
.tape-row { display:flex; align-items:center; gap:8px; margin-top:14px; }
.tape-track { flex:1; height:4px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden; }
.tape-fill { height:100%; border-radius:2px; width:0%; transition:width 0.4s cubic-bezier(.4,0,.2,1); background:linear-gradient(90deg, var(--glacier), #00d4ff); }
.tape-label { font-size:9px; color:var(--text-dim); white-space:nowrap; }

.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:12px; }
.stat-box { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:11px 8px; }
.stat-box .lbl { font-size:8px; letter-spacing:3px; text-transform:uppercase; color:var(--text-dim); margin-bottom:3px; }
.stat-box .val { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:22px; line-height:1; color:white; }
.stat-box .unt { font-size:9px; color:var(--text-dim); }

.sensor-row { display:flex; gap:7px; flex-wrap:wrap; margin-bottom:12px; }
.chip { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:6px 11px; font-size:10px; display:flex; align-items:center; gap:5px; color:var(--text-mid); flex-shrink:0; }
.chip strong { color:white; font-weight:500; }

.map-block { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; height:195px; position:relative; margin-bottom:12px; }
.inner-label { position:absolute; top:10px; left:12px; font-size:8px; letter-spacing:4px; text-transform:uppercase; color:var(--text-dim); z-index:5; background:rgba(8,14,20,0.7); padding:2px 7px; border-radius:4px; }
canvas { display:block; width:100%; height:100%; }
.map-no-data { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; color:var(--text-dim); font-size:10px; letter-spacing:3px; text-transform:uppercase; }

.chart-block { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; height:88px; position:relative; margin-bottom:12px; }

.live-controls { position:fixed; bottom:0; left:0; right:0; background:linear-gradient(transparent, var(--bg) 28%); padding:10px 14px 28px; display:flex; gap:10px; }
.btn-ctrl { flex:1; padding:16px; border:none; border-radius:14px; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:20px; letter-spacing:2px; cursor:pointer; transition:transform 0.15s; }
.btn-ctrl:active { transform:scale(0.96); }
.btn-ctrl.primary { background:var(--summit); color:white; box-shadow:0 4px 20px rgba(255,107,53,0.38); }
.btn-ctrl.secondary { background:var(--card); border:1px solid var(--border-lit); color:var(--text-mid); }
.btn-ctrl.success { background:rgba(74,222,128,0.14); border:1px solid rgba(74,222,128,0.3); color:var(--green); }

/* ── ANALYSIS ── */
#screenAnalysis { background:var(--bg); }
.ana-header { display:flex; align-items:center; gap:14px; padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
.btn-back { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; color:var(--text-mid); cursor:pointer; }
.ana-title { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:26px; flex:1; }
.ana-badge { font-size:9px; letter-spacing:3px; background:rgba(74,222,128,0.12); border:1px solid rgba(74,222,128,0.25); color:var(--green); padding:4px 9px; border-radius:20px; text-transform:uppercase; }
.ana-scroll { flex:1; overflow-y:auto; padding:16px 14px 40px; -webkit-overflow-scrolling:touch; }

.hero-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.hstat { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:18px 16px; position:relative; overflow:hidden; }
.hstat::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; }
.hstat.spd::after { background:linear-gradient(90deg, var(--summit), transparent); }
.hstat.avg::after { background:linear-gradient(90deg, var(--glacier), transparent); }
.hstat.dst::after { background:linear-gradient(90deg, var(--green), transparent); }
.hstat.alt::after { background:linear-gradient(90deg, var(--yellow), transparent); }
.hstat .lbl { font-size:8px; letter-spacing:4px; text-transform:uppercase; color:var(--text-dim); margin-bottom:6px; }
.hstat .big { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:46px; line-height:1; }
.hstat .unit { font-size:13px; color:var(--text-dim); }
.hstat .sub { font-size:10px; color:var(--text-dim); margin-top:4px; }
.hstat.spd .big { color:var(--summit); text-shadow:0 0 30px rgba(255,107,53,0.35); }
.hstat.avg .big { color:var(--glacier); }
.hstat.dst .big { color:var(--green); }
.hstat.alt .big { color:var(--yellow); }

.sec { font-size:9px; letter-spacing:5px; text-transform:uppercase; color:var(--text-dim); margin:18px 0 10px 2px; }

.ana-map { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; margin-bottom:14px; }
.map-legend { display:flex; gap:14px; padding:10px 14px; border-top:1px solid var(--border); flex-wrap:wrap; }
.leg { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--text-mid); }
.legdot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }

.ana-chart { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:10px; }
.chart-head { display:flex; justify-content:space-between; align-items:center; padding:12px 14px 0; }
.chart-head .ctitle { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; }
.chart-head .cval { font-size:10px; color:var(--text-dim); }

.dtable { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:14px; }
.drow { display:flex; justify-content:space-between; align-items:center; padding:11px 16px; border-bottom:1px solid var(--border); }
.drow:last-child { border-bottom:none; }
.drow .dk { color:var(--text-dim); font-size:11px; }
.drow .dv { font-family:'Barlow Condensed',sans-serif; font-size:18px; font-weight:600; }

.dist-bars { padding:14px; }
.dbrow { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.dblabel { font-size:10px; color:var(--text-mid); min-width:65px; text-align:right; }
.dbtrack { flex:1; height:8px; background:rgba(255,255,255,0.06); border-radius:4px; overflow:hidden; }
.dbfill { height:100%; border-radius:4px; }
.dbpct { font-size:10px; color:var(--text-dim); min-width:30px; text-align:right; }

.ach-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.ach { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px 8px; text-align:center; }
.ach .ai { font-size:26px; margin-bottom:6px; }
.ach .an { font-size:9px; letter-spacing:1px; color:var(--text-mid); }
.ach .av { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:700; color:white; margin-top:2px; }
.ach.unlocked { border-color:rgba(251,191,36,0.35); background:rgba(251,191,36,0.06); }

::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<!-- ONBOARDING -->
<div class="screen" id="screenOnboard">
  <svg class="ob-mountains" viewBox="0 0 375 420" preserveAspectRatio="xMidYMax meet" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="mg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="rgba(52,180,212,0.18)"/>
        <stop offset="100%" stop-color="rgba(52,180,212,0)"/>
      </linearGradient>
    </defs>
    <polygon points="0,420 0,230 50,140 120,200 185,80 260,180 330,60 375,130 375,420" fill="url(#mg)"/>
    <polygon points="0,420 0,310 90,230 160,280 230,210 310,260 375,220 375,420" fill="rgba(255,255,255,0.03)"/>
    <polygon points="50,140 30,185 72,182" fill="rgba(255,255,255,0.12)"/>
    <polygon points="185,80 162,130 210,127" fill="rgba(255,255,255,0.14)"/>
    <polygon points="330,60 305,115 355,112" fill="rgba(255,255,255,0.11)"/>
  </svg>

  <div class="ob-title">GIP<em>FEL</em></div>
  <div class="ob-sub">SKI TRACKING &middot; ALPINE PRO</div>

  <div class="feature-grid">
    <div class="feat">
      <div class="feat-icon">&#x26A1;</div>
      <div class="feat-name">Live Speed</div>
      <div class="feat-desc">GPS Echtzeit<br>km/h pr&auml;zise</div>
    </div>
    <div class="feat">
      <div class="feat-icon">&#x1F5FA;</div>
      <div class="feat-name">GPS Track</div>
      <div class="feat-desc">Strecke live<br>gezeichnet</div>
    </div>
    <div class="feat">
      <div class="feat-icon">&#x1F4CA;</div>
      <div class="feat-name">Analyse</div>
      <div class="feat-desc">Vollst&auml;ndige<br>Auswertung</div>
    </div>
    <div class="feat">
      <div class="feat-icon">&#x26F7;</div>
      <div class="feat-name">H&ouml;henprofil</div>
      <div class="feat-desc">H&ouml;henmeter &amp;<br>Abstieg live</div>
    </div>
  </div>

  <button class="btn-launch" onclick="gotoLive()">TRACKING STARTEN &#x2192;</button>
  <div class="install-banner" id="installBanner" onclick="installApp()">
    &#x2B07; Als App installieren &mdash; f&uuml;r schnellen Zugriff auf der Piste
  </div>
</div>

<!-- LIVE -->
<div class="screen hidden" id="screenLive">
  <div class="live-header">
    <div class="live-logo">GIP<span>FEL</span></div>
    <div class="pill"><div class="dot" id="gpsDot"></div><span id="gpsLabel">GPS SUCHE</span></div>
    <div class="pill" id="recPill" style="display:none"><div class="dot rec"></div><span>REC</span></div>
  </div>

  <div class="live-scroll">
    <div class="speed-block">
      <div class="speed-label">AKTUELLE GESCHWINDIGKEIT</div>
      <div class="speed-row">
        <div class="speed-num" id="liveSpeed">0</div>
        <div class="speed-sidestack">
          <span class="speed-unit">KM/H</span>
          <div class="speed-maxlive">MAX: <strong id="liveMax">0</strong> km/h</div>
        </div>
      </div>
      <div class="tape-row">
        <div class="tape-track"><div class="tape-fill" id="speedTape"></div></div>
        <div class="tape-label" id="tapeLabel">0 km/h</div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-box"><div class="lbl">Zeit</div><div class="val" id="liveTimer">0:00</div></div>
      <div class="stat-box"><div class="lbl">Distanz</div><div class="val" id="liveDist">0</div><div class="unt" id="liveDistU">m</div></div>
      <div class="stat-box"><div class="lbl">H&ouml;he</div><div class="val" id="liveAlt">&mdash;</div><div class="unt">m</div></div>
      <div class="stat-box"><div class="lbl">&#x00D8; Speed</div><div class="val" id="liveAvg">0</div><div class="unt">km/h</div></div>
    </div>

    <div class="sensor-row">
      <div class="chip">GPS &#xB1;<strong id="sAcc">&mdash;</strong>m</div>
      <div class="chip">&#x1F9ED; <strong id="sHead">&mdash;</strong></div>
      <div class="chip">Neig. <strong id="sTilt">&mdash;</strong>&#xB0;</div>
      <div class="chip">&#x1F50B; <strong id="sBat">&mdash;</strong></div>
      <div class="chip">&#x2B07; <strong id="sDes">0</strong>m</div>
      <div class="chip">&#x2B06; <strong id="sAsc">0</strong>m</div>
    </div>

    <div class="map-block">
      <div class="inner-label">GPS TRACK</div>
      <div class="map-no-data" id="mapNoData">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.35">
          <circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/>
          <circle cx="12" cy="12" r="9" opacity="0.5"/>
        </svg>
        GPS WARTEN...
      </div>
      <canvas id="liveMap"></canvas>
    </div>

    <div class="chart-block">
      <div class="inner-label" style="background:transparent">H&Ouml;HENPROFIL</div>
      <canvas id="liveAltCanvas"></canvas>
    </div>
  </div>

  <div class="live-controls">
    <button class="btn-ctrl primary" id="btnStart" onclick="startTracking()">&#x25B6; START</button>
    <button class="btn-ctrl secondary" id="btnPause" onclick="togglePause()" style="display:none">&#x23F8; PAUSE</button>
    <button class="btn-ctrl success" id="btnFinish" onclick="finishRun()" style="display:none">&#x2713; FERTIG</button>
  </div>
</div>

<!-- ANALYSIS -->
<div class="screen hidden" id="screenAnalysis">
  <div class="ana-header">
    <button class="btn-back" onclick="gotoLiveBack()">&#x2190; LIVE</button>
    <div class="ana-title">ANALYSE</div>
    <div class="ana-badge" id="anaBadge">RUN #1</div>
  </div>

  <div class="ana-scroll">
    <div class="hero-stats">
      <div class="hstat spd"><div class="lbl">Top Speed</div><div class="big" id="aTopSpd">&mdash;<span class="unit">km/h</span></div><div class="sub" id="aTopSub"></div></div>
      <div class="hstat avg"><div class="lbl">&#x00D8; Geschwindigkeit</div><div class="big" id="aAvgSpd">&mdash;<span class="unit">km/h</span></div><div class="sub" id="aAvgSub"></div></div>
      <div class="hstat dst"><div class="lbl">Distanz</div><div class="big" id="aDist">&mdash;</div><div class="sub" id="aDistSub"></div></div>
      <div class="hstat alt"><div class="lbl">H&ouml;henmeter &#x2193;</div><div class="big" id="aDes">&mdash;<span class="unit">m</span></div><div class="sub" id="aDesSub"></div></div>
    </div>

    <div class="sec">GPS TRACK &mdash; NACH GESCHWINDIGKEIT EINGEF&Auml;RBT</div>
    <div class="ana-map">
      <canvas id="anaMap" style="height:260px"></canvas>
      <div class="map-legend">
        <div class="leg"><div class="legdot" style="background:#34b4d4"></div>Langsam</div>
        <div class="leg"><div class="legdot" style="background:#4ade80"></div>Mittel</div>
        <div class="leg"><div class="legdot" style="background:#ff6b35"></div>Schnell</div>
        <div class="leg"><div class="legdot" style="background:white"></div>Start/Ende</div>
      </div>
    </div>

    <div class="sec">GESCHWINDIGKEIT &Uuml;BER ZEIT</div>
    <div class="ana-chart">
      <div class="chart-head"><div class="ctitle">Speed</div><div class="cval" id="cSpdRange">&mdash;</div></div>
      <canvas id="anaSpd" style="height:130px"></canvas>
    </div>

    <div class="sec">H&Ouml;HENPROFIL</div>
    <div class="ana-chart">
      <div class="chart-head"><div class="ctitle">H&ouml;he</div><div class="cval" id="cAltRange">&mdash;</div></div>
      <canvas id="anaAlt" style="height:130px"></canvas>
    </div>

    <div class="sec">GESCHWINDIGKEITSVERTEILUNG</div>
    <div class="dtable"><div class="dist-bars" id="speedDist"></div></div>

    <div class="sec">ALLE DATEN</div>
    <div class="dtable" id="fullTable"></div>

    <div class="sec">ACHIEVEMENTS</div>
    <div class="ach-grid" id="achGrid"></div>

    <div class="sec">GPS DETAILS</div>
    <div class="dtable" id="gpsTable"></div>

    <div class="sec">EXPORT</div>
    <div class="dtable">
      <div class="drow">
        <span class="dk">GPS Rohdaten (JSON)</span>
        <button onclick="exportJSON()" style="background:rgba(52,180,212,0.15);border:1px solid rgba(52,180,212,0.3);color:var(--glacier);padding:6px 14px;border-radius:8px;font-family:'DM Mono';font-size:11px;cursor:pointer;">EXPORT</button>
      </div>
    </div>
  </div>
</div>

<script>
// ══ STATE ══
const S = {
  tracking:false, paused:false,
  positions:[], altitudes:[], speeds:[],
  startTime:null, timerInterval:null, watchId:null,
  maxSpeed:0, totalDist:0, totalDescent:0, totalAscent:0,
  prevAlt:null, runCount:0, gpsReady:false,
  orient:{beta:0,alpha:0}, battery:null
};

// ══ PWA INSTALL ══
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});
function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(() => {
    deferredPrompt = null;
    document.getElementById('installBanner').classList.remove('show');
  });
}

// ══ SERVICE WORKER ══
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

// ══ NAV ══
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function gotoLive() { show('screenLive'); if(!S.gpsReady) initSensors(); }
function gotoLiveBack() { show('screenLive'); }
function gotoAnalysis() { show('screenAnalysis'); setTimeout(buildAnalysis, 60); }

// ══ SENSORS ══
async function initSensors() {
  S.gpsReady = true;

  try {
    const bat = await navigator.getBattery?.();
    if (bat) {
      S.battery = bat;
      const upd = () => el('sBat').textContent = Math.round(bat.level*100)+'%'+(bat.charging?'+':'');
      bat.addEventListener('levelchange', upd);
      bat.addEventListener('chargingchange', upd);
      upd();
    }
  } catch(e){}

  if (window.DeviceOrientationEvent) {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
    }
    window.addEventListener('deviceorientation', e => {
      S.orient = e;
      el('sTilt').textContent = Math.round(Math.abs(e.beta||0));
      if (e.alpha!=null) el('sHead').textContent = Math.round(e.alpha)+'°';
    }, {passive:true});
  }

  if (!navigator.geolocation) { alert('GPS nicht verfügbar.'); return; }
  el('gpsDot').className = 'dot warn';
  el('gpsLabel').textContent = 'GPS SUCHE';

  S.watchId = navigator.geolocation.watchPosition(onPos, onPosErr, {
    enableHighAccuracy:true, timeout:15000, maximumAge:0
  });

  try { if('wakeLock' in navigator) navigator.wakeLock.request('screen'); } catch(e){}
}

function onPos(pos) {
  const c = pos.coords;
  el('sAcc').textContent = Math.round(c.accuracy);

  if (c.accuracy <= 20) { el('gpsDot').className='dot gps'; el('gpsLabel').textContent='GPS OK'; }
  else { el('gpsDot').className='dot warn'; el('gpsLabel').textContent='GPS SCHWACH'; }

  if (c.heading!=null) el('sHead').textContent = Math.round(c.heading)+'°';

  const alt = c.altitude!=null ? Math.round(c.altitude) : null;
  if (alt!==null) el('liveAlt').textContent = alt;

  if (!S.tracking || S.paused) return;

  let kmh = 0;
  if (c.speed!=null && c.speed>=0) kmh = c.speed*3.6;
  else if (S.positions.length>0) {
    const p = S.positions[S.positions.length-1];
    const d = haversine(p.lat,p.lon,c.latitude,c.longitude);
    const dt = (pos.timestamp-p.t)/1000;
    if (dt>0.5) kmh = (d/dt)*3.6;
  }
  kmh = Math.max(0, Math.min(300, kmh));

  el('liveSpeed').textContent = Math.round(kmh);
  const pct = Math.min(kmh/120*100, 100);
  el('speedTape').style.width = pct+'%';
  el('tapeLabel').textContent = Math.round(kmh)+' km/h';
  el('liveSpeed').style.color = kmh>80?'var(--summit)':kmh>50?'var(--yellow)':'white';

  if (kmh>S.maxSpeed) { S.maxSpeed=kmh; el('liveMax').textContent=Math.round(kmh); }
  S.speeds.push({t:pos.timestamp,v:kmh});

  if (alt!==null) {
    S.altitudes.push({t:pos.timestamp,v:alt});
    if (S.prevAlt!==null) {
      const d=alt-S.prevAlt;
      if(d<0){S.totalDescent+=Math.abs(d);el('sDes').textContent=Math.round(S.totalDescent);}
      if(d>0){S.totalAscent+=d;el('sAsc').textContent=Math.round(S.totalAscent);}
    }
    S.prevAlt=alt;
  }

  if (S.positions.length>0) {
    const p=S.positions[S.positions.length-1];
    const d=haversine(p.lat,p.lon,c.latitude,c.longitude);
    if(d<300) S.totalDist+=d;
  }
  if(S.totalDist>=1000){el('liveDist').textContent=(S.totalDist/1000).toFixed(2);el('liveDistU').textContent='km';}
  else{el('liveDist').textContent=Math.round(S.totalDist);el('liveDistU').textContent='m';}

  if(S.speeds.length>0) el('liveAvg').textContent=Math.round(S.speeds.reduce((a,b)=>a+b.v,0)/S.speeds.length);

  S.positions.push({lat:c.latitude,lon:c.longitude,alt,spd:kmh,head:c.heading,acc:c.accuracy,t:pos.timestamp});
  el('mapNoData').style.display='none';
  redrawLiveMap(); redrawLiveAlt();
}

function onPosErr() { el('gpsDot').className='dot'; el('gpsLabel').textContent='GPS FEHLER'; }

// ══ CONTROLS ══
function startTracking() {
  S.tracking=true; S.paused=false; S.startTime=Date.now();
  S.positions=[]; S.altitudes=[]; S.speeds=[];
  S.maxSpeed=0; S.totalDist=0; S.totalDescent=0; S.totalAscent=0; S.prevAlt=null;
  el('btnStart').style.display='none';
  el('btnPause').style.display='flex';
  el('btnFinish').style.display='flex';
  el('recPill').style.display='flex';
  S.timerInterval=setInterval(()=>{
    if(S.paused)return;
    const e=Date.now()-S.startTime;
    el('liveTimer').textContent=Math.floor(e/60000)+':'+(Math.floor((e%60000)/1000)+'').padStart(2,'0');
  },500);
}

function togglePause() {
  S.paused=!S.paused;
  el('btnPause').innerHTML=S.paused?'&#x25B6; WEITER':'&#x23F8; PAUSE';
}

function finishRun() {
  S.tracking=false; S.paused=false;
  clearInterval(S.timerInterval); S.runCount++;
  el('btnStart').style.display='flex';
  el('btnPause').style.display='none';
  el('btnFinish').style.display='none';
  el('recPill').style.display='none';
  gotoAnalysis();
}

// ══ CANVAS ══
function redrawLiveMap() { drawMap(el('liveMap'),S.positions,195,false); }
function redrawLiveAlt() { drawAlt(el('liveAltCanvas'),S.altitudes,88,'#34b4d4','rgba(52,180,212,0.15)'); }

function setupCanvas(canvas,height) {
  const dpr=window.devicePixelRatio||1, W=canvas.offsetWidth;
  canvas.width=W*dpr; canvas.height=height*dpr; canvas.style.height=height+'px';
  const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
  return {ctx,W,H:height};
}

function drawMap(canvas,pts,height,analysis) {
  const {ctx,W,H}=setupCanvas(canvas,height);
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='rgba(255,255,255,0.04)'; ctx.lineWidth=0.5;
  for(let i=1;i<5;i++){ctx.beginPath();ctx.moveTo(W*i/5,0);ctx.lineTo(W*i/5,H);ctx.stroke();ctx.beginPath();ctx.moveTo(0,H*i/5);ctx.lineTo(W,H*i/5);ctx.stroke();}
  if(pts.length<2)return;
  const lats=pts.map(p=>p.lat),lons=pts.map(p=>p.lon);
  const minLat=Math.min(...lats),maxLat=Math.max(...lats),minLon=Math.min(...lons),maxLon=Math.max(...lons);
  const latR=maxLat-minLat||0.0001,lonR=maxLon-minLon||0.0001,pad=36;
  const scale=Math.min((W-pad*2)/lonR,(H-pad*2)/latR);
  const clat=(minLat+maxLat)/2,clon=(minLon+maxLon)/2;
  const xy=(lat,lon)=>[W/2+(lon-clon)*scale,H/2-(lat-clat)*scale];
  const maxS=Math.max(...pts.map(p=>p.spd),0.1);
  ctx.globalAlpha=0.22;
  for(let i=1;i<pts.length;i++){const[x1,y1]=xy(pts[i-1].lat,pts[i-1].lon),[x2,y2]=xy(pts[i].lat,pts[i].lon);ctx.strokeStyle=spdColor(pts[i].spd/maxS);ctx.lineWidth=9;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
  ctx.globalAlpha=1;
  for(let i=1;i<pts.length;i++){const[x1,y1]=xy(pts[i-1].lat,pts[i-1].lon),[x2,y2]=xy(pts[i].lat,pts[i].lon);ctx.strokeStyle=spdColor(pts[i].spd/maxS);ctx.lineWidth=2.5;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
  const[sx,sy]=xy(pts[0].lat,pts[0].lon);ctx.fillStyle='#4ade80';ctx.shadowColor='#4ade80';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(sx,sy,5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  const last=pts[pts.length-1],[ex,ey]=xy(last.lat,last.lon);ctx.fillStyle='white';ctx.shadowColor='#00d4ff';ctx.shadowBlur=14;ctx.beginPath();ctx.arc(ex,ey,6,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  if(analysis){ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px "DM Mono"';ctx.textAlign='left';if(sx<W-50)ctx.fillText('START',sx+9,sy+4);if(ex<W-50)ctx.fillText('ENDE',ex+9,ey+4);}
}

function drawSpeedChart(canvas,spds) {
  const {ctx,W,H}=setupCanvas(canvas,130); ctx.clearRect(0,0,W,H);
  if(spds.length<2)return;
  const vals=spds.map(s=>s.v),maxV=Math.max(...vals,1);
  const pad={t:20,b:22,l:8,r:8};
  const x=i=>pad.l+(i/(vals.length-1))*(W-pad.l-pad.r);
  const y=v=>pad.t+(1-v/maxV)*(H-pad.t-pad.b);
  const grad=ctx.createLinearGradient(0,pad.t,0,H);
  grad.addColorStop(0,'rgba(255,107,53,0.4)');grad.addColorStop(1,'rgba(255,107,53,0)');
  ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(x(0),H);
  vals.forEach((v,i)=>ctx.lineTo(x(i),y(v)));ctx.lineTo(x(vals.length-1),H);ctx.closePath();ctx.fill();
  ctx.strokeStyle='#ff6b35';ctx.lineWidth=2;ctx.lineJoin='round';ctx.beginPath();
  vals.forEach((v,i)=>i===0?ctx.moveTo(x(i),y(v)):ctx.lineTo(x(i),y(v)));ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px "DM Mono"';ctx.textAlign='left';
  ctx.fillText(Math.round(maxV)+' km/h',pad.l+4,pad.t+9);
  el('cSpdRange').textContent='0 – '+Math.round(maxV)+' km/h';
}

function drawAlt(canvas,alts,height,color,fill) {
  const {ctx,W,H}=setupCanvas(canvas,height); ctx.clearRect(0,0,W,H);
  if(alts.length<2)return;
  const vals=alts.map(a=>a.v),maxV=Math.max(...vals),minV=Math.min(...vals),range=maxV-minV||1;
  const pad={t:20,b:14,l:6,r:6};
  const x=i=>pad.l+(i/(vals.length-1))*(W-pad.l-pad.r);
  const y=v=>pad.t+(1-(v-minV)/range)*(H-pad.t-pad.b);
  const grad=ctx.createLinearGradient(0,pad.t,0,H);
  grad.addColorStop(0,fill.replace(/[\d.]+\)$/,'0.4)'));grad.addColorStop(1,fill.replace(/[\d.]+\)$/,'0)'));
  ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(x(0),H);
  vals.forEach((v,i)=>ctx.lineTo(x(i),y(v)));ctx.lineTo(x(vals.length-1),H);ctx.closePath();ctx.fill();
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.lineJoin='round';ctx.beginPath();
  vals.forEach((v,i)=>i===0?ctx.moveTo(x(i),y(v)):ctx.lineTo(x(i),y(v)));ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='9px "DM Mono"';ctx.textAlign='left';
  ctx.fillText(maxV+'m',pad.l+4,pad.t-2);ctx.fillText(minV+'m',pad.l+4,H-2);
  if(el('cAltRange'))el('cAltRange').textContent=minV+'m – '+maxV+'m ü.M.';
}

function spdColor(t) {
  t=Math.max(0,Math.min(1,t));
  if(t<0.5){const f=t*2;return`rgb(${Math.round(52+f*(74-52))},${Math.round(180+f*(222-180))},${Math.round(212+f*(128-212))})`;}
  const f=(t-0.5)*2;return`rgb(${Math.round(74+f*(255-74))},${Math.round(222+f*(107-222))},${Math.round(128+f*(53-128))})`;
}

// ══ ANALYSIS ══
function buildAnalysis() {
  const pts=S.positions,spds=S.speeds,alts=S.altitudes;
  const dur=S.startTime?Date.now()-S.startTime:0;
  const m=Math.floor(dur/60000),s=Math.floor((dur%60000)/1000),tStr=m+':'+(s+'').padStart(2,'0');
  el('anaBadge').textContent='RUN #'+S.runCount;
  const topSpd=Math.round(S.maxSpeed),avgSpd=spds.length?Math.round(spds.reduce((a,b)=>a+b.v,0)/spds.length):0;
  el('aTopSpd').innerHTML=topSpd+'<span class="unit">km/h</span>';
  el('aTopSub').textContent='Dein Rekord dieser Abfahrt';
  el('aAvgSpd').innerHTML=avgSpd+'<span class="unit">km/h</span>';
  el('aAvgSub').textContent='über '+tStr;
  const dStr=S.totalDist>=1000?(S.totalDist/1000).toFixed(2)+'<span class="unit">km</span>':Math.round(S.totalDist)+'<span class="unit">m</span>';
  el('aDist').innerHTML=dStr; el('aDistSub').textContent=pts.length+' GPS Punkte';
  el('aDes').innerHTML=Math.round(S.totalDescent)+'<span class="unit">m</span>';
  el('aDesSub').textContent='↑ '+Math.round(S.totalAscent)+'m aufgestiegen';
  drawMap(el('anaMap'),pts,260,true);
  drawSpeedChart(el('anaSpd'),spds);
  drawAlt(el('anaAlt'),alts,130,'#fbbf24','rgba(251,191,36,0.12)');
  buildSpeedDist(spds);
  buildFullTable(dur,tStr,pts,spds,alts);
  buildAchievements(topSpd,avgSpd,S.totalDist,S.totalDescent,pts.length);
  buildGPSTable(pts);
}

function buildSpeedDist(spds) {
  if(!spds.length)return;
  const bins=[{l:'0–20',min:0,max:20,c:'#34b4d4'},{l:'20–40',min:20,max:40,c:'#4ade80'},{l:'40–60',min:40,max:60,c:'#fbbf24'},{l:'60–80',min:60,max:80,c:'#fb923c'},{l:'80+',min:80,max:999,c:'#f87171'}];
  bins.forEach(b=>{b.n=spds.filter(s=>s.v>=b.min&&s.v<b.max).length;b.p=Math.round(b.n/spds.length*100);});
  const mp=Math.max(...bins.map(b=>b.p),1);
  el('speedDist').innerHTML=bins.map(b=>`<div class="dbrow"><div class="dblabel">${b.l} km/h</div><div class="dbtrack"><div class="dbfill" style="width:${b.p/mp*100}%;background:${b.c}"></div></div><div class="dbpct">${b.p}%</div></div>`).join('');
}

function buildFullTable(dur,tStr,pts,spds,alts) {
  const topSpd=Math.round(S.maxSpeed),avgSpd=spds.length?Math.round(spds.reduce((a,b)=>a+b.v,0)/spds.length):0;
  const minSpd=spds.length?Math.round(Math.min(...spds.map(s=>s.v))):0;
  const minAlt=alts.length?Math.min(...alts.map(a=>a.v)):'—',maxAlt=alts.length?Math.max(...alts.map(a=>a.v)):'—';
  const avgAcc=pts.length?Math.round(pts.reduce((a,b)=>a+(b.acc||20),0)/pts.length):'—';
  const rows=[
    ['Fahrzeit',tStr],['Distanz',S.totalDist>=1000?(S.totalDist/1000).toFixed(3)+' km':Math.round(S.totalDist)+' m'],
    ['Top Speed',topSpd+' km/h'],['Mindest-Speed',minSpd+' km/h'],['Ø Geschwindigkeit',avgSpd+' km/h'],
    ['Abgefahrene Höhenmeter',Math.round(S.totalDescent)+' m'],['Aufgestiegene Höhenmeter',Math.round(S.totalAscent)+' m'],
    ['Netto Höhenverlust',Math.round(S.totalDescent-S.totalAscent)+' m'],
    ['Höhe min / max',minAlt+'m / '+maxAlt+'m'],['GPS Punkte',pts.length],
    ['Ø GPS Genauigkeit','±'+avgAcc+'m'],['Abfahrten gesamt',S.runCount],
    ['Datum',new Date().toLocaleDateString('de-DE',{weekday:'short',day:'2-digit',month:'short',year:'numeric'})],
  ];
  el('fullTable').innerHTML=rows.map(([k,v])=>`<div class="drow"><span class="dk">${k}</span><span class="dv">${v}</span></div>`).join('');
}

function buildAchievements(topSpd,avgSpd,dist,descent,nPts) {
  const items=[
    {icon:topSpd>=100?'&#x1F525;':topSpd>=80?'&#x26A1;':topSpd>=50?'&#x1F4A8;':'&#x2744;',name:'Top Speed',val:topSpd+' km/h',u:topSpd>=50},
    {icon:descent>=500?'&#x26F0;':descent>=200?'&#x26F7;':'&#x1F30A;',name:'Höhenmeter',val:Math.round(descent)+'m',u:descent>=200},
    {icon:dist>=5000?'&#x1F30D;':dist>=2000?'&#x1F4CD;':'&#x1F5FA;',name:'Distanz',val:dist>=1000?(dist/1000).toFixed(1)+'km':Math.round(dist)+'m',u:dist>=2000},
    {icon:avgSpd>=40?'&#x1F3BF;':avgSpd>=20?'&#x1F3C2;':'&#x1F40C;',name:'Ø Speed',val:avgSpd+' km/h',u:avgSpd>=20},
    {icon:topSpd>=100?'&#x1F4AF;':'&#x1F3AF;',name:'100 km/h',val:topSpd>=100?'ERREICHT!':Math.round(topSpd)+'/100',u:topSpd>=100},
    {icon:nPts>=200?'&#x1F4E1;':'&#x1F4CA;',name:'GPS Punkte',val:nPts+' pts',u:nPts>=50},
  ];
  el('achGrid').innerHTML=items.map(a=>`<div class="ach ${a.u?'unlocked':''}"><div class="ai">${a.icon}</div><div class="an">${a.name}</div><div class="av">${a.val}</div></div>`).join('');
}

function buildGPSTable(pts) {
  if(!pts.length){el('gpsTable').innerHTML='<div class="drow"><span class="dk">Keine GPS Daten</span></div>';return;}
  const f=pts[0],l=pts[pts.length-1];
  const rows=[
    ['Start Koordinaten',f.lat.toFixed(6)+', '+f.lon.toFixed(6)],
    ['End Koordinaten',l.lat.toFixed(6)+', '+l.lon.toFixed(6)],
    ['Start Höhe',f.alt!=null?f.alt+'m':'—'],['End Höhe',l.alt!=null?l.alt+'m':'—'],
    ['GPS Genauigkeit Start','±'+Math.round(f.acc||0)+'m'],['GPS Genauigkeit Ende','±'+Math.round(l.acc||0)+'m'],
    ['Erste Messung',new Date(f.t).toLocaleTimeString('de-DE')],['Letzte Messung',new Date(l.t).toLocaleTimeString('de-DE')],
  ];
  el('gpsTable').innerHTML=rows.map(([k,v])=>`<div class="drow"><span class="dk">${k}</span><span class="dv" style="font-size:13px">${v}</span></div>`).join('');
}

function exportJSON() {
  const data={run:S.runCount,date:new Date().toISOString(),maxSpeed_kmh:Math.round(S.maxSpeed),dist_m:Math.round(S.totalDist),descent_m:Math.round(S.totalDescent),ascent_m:Math.round(S.totalAscent),positions:S.positions.map(p=>({lat:p.lat.toFixed(7),lon:p.lon.toFixed(7),alt:p.alt,spd:Math.round(p.spd),acc:Math.round(p.acc||0),t:new Date(p.t).toISOString()}))};
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  a.download='gipfel_run'+S.runCount+'_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
}

// ══ UTILS ══
const el=id=>document.getElementById(id);
function haversine(lat1,lon1,lat2,lon2){const R=6371000,dL=(lat2-lat1)*Math.PI/180,dO=(lon2-lon1)*Math.PI/180,a=Math.sin(dL/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
window.addEventListener('resize',()=>{if(S.positions.length>1){redrawLiveMap();redrawLiveAlt();}});
</script>
</body>
</html>
