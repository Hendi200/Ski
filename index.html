<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GIPFEL \u2014 Ski Tracker</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;600;700;900&family=DM+Mono:wght@300;400;500&display=swap');

:root {
  --bg: #080e14;
  --surface: #0d1821;
  --card: #111d2b;
  --border: rgba(255,255,255,0.07);
  --border-lit: rgba(255,255,255,0.16);
  --snow: #eef4ff;
  --ice: #7dd3e8;
  --glacier: #34b4d4;
  --speed-glow: #00d4ff;
  --summit: #ff6b35;
  --green: #4ade80;
  --yellow: #fbbf24;
  --red: #f87171;
  --text-dim: rgba(238,244,255,0.38);
  --text-mid: rgba(238,244,255,0.65);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; }
body { background:var(--bg); color:var(--snow); font-family:'DM Mono',monospace; font-size:13px; }

/* SCREENS */
.screen { position:fixed; inset:0; display:flex; flex-direction:column; overflow:hidden; transition:opacity 0.35s, transform 0.35s; }
.screen.hidden { opacity:0; pointer-events:none; transform:scale(0.97); }

/* \u2500\u2500 ONBOARDING \u2500\u2500 */
#screenOnboard {
  align-items:center; justify-content:center; text-align:center;
  background:radial-gradient(ellipse at 50% 20%, #0e2d4a 0%, #080e14 65%);
  padding:32px 28px;
}
.ob-mountains { position:absolute; bottom:0; left:0; right:0; height:55%; pointer-events:none; }
.ob-title { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:80px; letter-spacing:-3px; line-height:0.88; color:white; position:relative; z-index:2; }
.ob-title em { color:var(--glacier); font-style:normal; }
.ob-sub { font-size:10px; letter-spacing:6px; text-transform:uppercase; color:var(--text-dim); margin:14px 0 36px; position:relative; z-index:2; }
.feature-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; max-width:340px; margin-bottom:32px; position:relative; z-index:2; }
.feat { background:rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:14px; padding:14px 12px; text-align:left; }
.feat-icon { font-size:22px; margin-bottom:6px; }
.feat-name { font-family:'Barlow Condensed',sans-serif; font-size:16px; font-weight:700; color:var(--snow); }
.feat-desc { font-size:9px; color:var(--text-dim); margin-top:2px; line-height:1.5; }
.btn-launch { width:100%; max-width:300px; padding:20px 0; background:var(--summit); border:none; border-radius:16px; font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:26px; letter-spacing:3px; color:white; cursor:pointer; box-shadow:0 8px 40px rgba(255,107,53,0.4), inset 0 1px 0 rgba(255,255,255,0.2); position:relative; z-index:2; transition:transform 0.15s; }
.btn-launch:active { transform:scale(0.96); }

/* \u2500\u2500 LIVE SCREEN \u2500\u2500 */
#screenLive { background:var(--bg); }
.live-header { display:flex; align-items:center; justify-content:space-between; padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
.live-logo { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:24px; letter-spacing:1px; }
.live-logo span { color:var(--glacier); }
.pill { display:flex; align-items:center; gap:5px; background:var(--card); border:1px solid var(--border); border-radius:20px; padding:5px 11px; font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--text-mid); }
.dot { width:6px; height:6px; border-radius:50%; background:#333; flex-shrink:0; }
.dot.gps { background:var(--green); box-shadow:0 0 6px var(--green); animation:blink 1.5s infinite; }
.dot.warn { background:var(--yellow); box-shadow:0 0 6px var(--yellow); animation:blink 0.8s infinite; }
.dot.rec { background:var(--red); animation:blink 0.7s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

.live-scroll { flex:1; overflow-y:auto; padding:14px 14px 110px; -webkit-overflow-scrolling:touch; }

/* Speed block */
.speed-block { background:linear-gradient(150deg, #0d2035 0%, #080e14 100%); border:1px solid var(--border); border-radius:20px; padding:22px 22px 16px; margin-bottom:12px; position:relative; overflow:hidden; }
.speed-block::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 50% 0%, rgba(0,212,255,0.07) 0%, transparent 65%); pointer-events:none; }
.speed-label { font-size:9px; letter-spacing:5px; text-transform:uppercase; color:var(--text-dim); margin-bottom:4px; }
.speed-row { display:flex; align-items:flex-end; gap:10px; }
.speed-num { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:96px; line-height:0.9; color:white; text-shadow:0 0 50px rgba(0,212,255,0.45); transition:color 0.3s; min-width:170px; }
.speed-sidestack { padding-bottom:8px; }
.speed-unit { font-size:14px; color:var(--ice); letter-spacing:2px; display:block; }
.speed-maxlive { font-size:10px; color:var(--text-dim); margin-top:6px; }
.tape-row { display:flex; align-items:center; gap:8px; margin-top:14px; }
.tape-track { flex:1; height:4px; background:rgba(255,255,255,0.08); border-radius:2px; overflow:hidden; }
.tape-fill { height:100%; border-radius:2px; width:0%; transition:width 0.4s cubic-bezier(.4,0,.2,1); background:linear-gradient(90deg, var(--glacier), var(--speed-glow)); }
.tape-label { font-size:9px; color:var(--text-dim); white-space:nowrap; }

/* Stats row */
.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:12px; }
.stat-box { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:11px 8px; }
.stat-box .lbl { font-size:8px; letter-spacing:3px; text-transform:uppercase; color:var(--text-dim); margin-bottom:3px; }
.stat-box .val { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:22px; line-height:1; color:white; }
.stat-box .unt { font-size:9px; color:var(--text-dim); }

/* Sensor row */
.sensor-row { display:flex; gap:7px; flex-wrap:wrap; margin-bottom:12px; }
.chip { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:6px 11px; font-size:10px; display:flex; align-items:center; gap:5px; color:var(--text-mid); flex-shrink:0; }
.chip strong { color:white; font-weight:500; }

/* Map block */
.map-block { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; height:195px; position:relative; margin-bottom:12px; }
.inner-label { position:absolute; top:10px; left:12px; font-size:8px; letter-spacing:4px; text-transform:uppercase; color:var(--text-dim); z-index:5; background:rgba(8,14,20,0.7); padding:2px 7px; border-radius:4px; }
canvas { display:block; width:100%; height:100%; }
.map-no-data { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; color:var(--text-dim); font-size:10px; letter-spacing:3px; text-transform:uppercase; }

/* Chart block */
.chart-block { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; height:88px; position:relative; margin-bottom:12px; }

/* Live controls */
.live-controls { position:fixed; bottom:0; left:0; right:0; background:linear-gradient(transparent, var(--bg) 28%); padding:10px 14px 22px; display:flex; gap:10px; }
.btn-ctrl { flex:1; padding:16px; border:none; border-radius:14px; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:20px; letter-spacing:2px; cursor:pointer; transition:transform 0.15s; }
.btn-ctrl:active { transform:scale(0.96); }
.btn-ctrl.primary { background:var(--summit); color:white; box-shadow:0 4px 20px rgba(255,107,53,0.38); }
.btn-ctrl.secondary { background:var(--card); border:1px solid var(--border-lit); color:var(--text-mid); }
.btn-ctrl.success { background:rgba(74,222,128,0.14); border:1px solid rgba(74,222,128,0.3); color:var(--green); }

/* \u2500\u2500 ANALYSIS SCREEN \u2500\u2500 */
#screenAnalysis { background:var(--bg); }
.ana-header { display:flex; align-items:center; gap:14px; padding:16px 20px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
.btn-back { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 12px; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; color:var(--text-mid); cursor:pointer; letter-spacing:1px; }
.ana-title { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:26px; flex:1; }
.ana-badge { font-size:9px; letter-spacing:3px; background:rgba(74,222,128,0.12); border:1px solid rgba(74,222,128,0.25); color:var(--green); padding:4px 9px; border-radius:20px; text-transform:uppercase; }
.ana-scroll { flex:1; overflow-y:auto; padding:16px 14px 40px; -webkit-overflow-scrolling:touch; }

/* Hero stats */
.hero-stats { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.hstat { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:18px 16px; position:relative; overflow:hidden; }
.hstat::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; }
.hstat.spd::after { background:linear-gradient(90deg, var(--summit), transparent); }
.hstat.avg::after { background:linear-gradient(90deg, var(--glacier), transparent); }
.hstat.dst::after { background:linear-gradient(90deg, var(--green), transparent); }
.hstat.alt::after { background:linear-gradient(90deg, var(--yellow), transparent); }
.hstat .lbl { font-size:8px; letter-spacing:4px; text-transform:uppercase; color:var(--text-dim); margin-bottom:6px; }
.hstat .big { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:46px; line-height:1; }
.hstat .unit { font-size:13px; color:var(--text-dim); }
.hstat .sub { font-size:10px; color:var(--text-dim); margin-top:4px; }
.hstat.spd .big { color:var(--summit); text-shadow:0 0 30px rgba(255,107,53,0.35); }
.hstat.avg .big { color:var(--glacier); }
.hstat.dst .big { color:var(--green); }
.hstat.alt .big { color:var(--yellow); }

/* Section title */
.sec { font-size:9px; letter-spacing:5px; text-transform:uppercase; color:var(--text-dim); margin:18px 0 10px 2px; }

/* Ana map */
.ana-map { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; margin-bottom:14px; }
.map-legend { display:flex; gap:14px; padding:10px 14px; border-top:1px solid var(--border); flex-wrap:wrap; }
.leg { display:flex; align-items:center; gap:6px; font-size:10px; color:var(--text-mid); }
.legdot { width:9px; height:9px; border-radius:50%; }

/* Ana chart */
.ana-chart { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:10px; }
.chart-head { display:flex; justify-content:space-between; align-items:center; padding:12px 14px 0; }
.chart-head .ctitle { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:16px; }
.chart-head .cval { font-size:10px; color:var(--text-dim); }

/* Data table */
.dtable { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:14px; }
.drow { display:flex; justify-content:space-between; align-items:center; padding:11px 16px; border-bottom:1px solid var(--border); }
.drow:last-child { border-bottom:none; }
.drow .dk { color:var(--text-dim); font-size:11px; }
.drow .dv { font-family:'Barlow Condensed',sans-serif; font-size:18px; font-weight:600; }

/* Speed dist */
.dist-bars { padding:14px; }
.dbrow { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.dblabel { font-size:10px; color:var(--text-mid); min-width:65px; text-align:right; }
.dbtrack { flex:1; height:8px; background:rgba(255,255,255,0.06); border-radius:4px; overflow:hidden; }
.dbfill { height:100%; border-radius:4px; transition:width 0.8s ease; }
.dbpct { font-size:10px; color:var(--text-dim); min-width:30px; text-align:right; }

/* Achievements */
.ach-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:14px; }
.ach { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px 8px; text-align:center; }
.ach .ai { font-size:26px; margin-bottom:6px; }
.ach .an { font-size:9px; letter-spacing:1px; color:var(--text-mid); }
.ach .av { font-family:'Barlow Condensed',sans-serif; font-size:15px; font-weight:700; color:white; margin-top:2px; }
.ach.unlocked { border-color:rgba(251,191,36,0.35); background:rgba(251,191,36,0.06); }

::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<!-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 ONBOARDING \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 -->
<div class="screen" id="screenOnboard">
  <svg class="ob-mountains" viewBox="0 0 375 420" preserveAspectRatio="xMidYMax meet" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <linearGradient id="mg" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="rgba(52,180,212,0.18)"/>
        <stop offset="100%" stop-color="rgba(52,180,212,0)"/>
      </linearGradient>
    </defs>
    <polygon points="0,420 0,230 50,140 120,200 185,80 260,180 330,60 375,130 375,420" fill="url(#mg)"/>
    <polygon points="0,420 0,310 90,230 160,280 230,210 310,260 375,220 375,420" fill="rgba(255,255,255,0.03)"/>
    <polygon points="50,140 30,185 72,182" fill="rgba(255,255,255,0.12)"/>
    <polygon points="185,80 162,130 210,127" fill="rgba(255,255,255,0.14)"/>
    <polygon points="330,60 305,115 355,112" fill="rgba(255,255,255,0.11)"/>
  </svg>

  <div class="ob-title">GIP<em>FEL</em></div>
  <div class="ob-sub">Ski Tracking \u00b7 Alpine Pro</div>

  <div class="feature-grid">
    <div class="feat"><div class="feat-icon">\u26a1</div><div class="feat-name">Live Speed</div><div class="feat-desc">GPS Echtzeit<br>km/h pr\u00e4zise</div></div>
    <div class="feat"><div class="feat-icon">\ud83d\uddfa\ufe0f</div><div class="feat-name">GPS Track</div><div class="feat-desc">Strecke live<br>gezeichnet</div></div>
    <div class="feat"><div class="feat-icon">\ud83d\udcca</div><div class="feat-name">Analyse</div><div class="feat-desc">Vollst\u00e4ndige<br>Auswertung</div></div>
    <div class="feat"><div class="feat-icon">\ud83c\udfd4\ufe0f</div><div class="feat-name">H\u00f6henprofil</div><div class="feat-desc">H\u00f6henmeter &<br>Abstieg live</div></div>
  </div>

  <button class="btn-launch" onclick="gotoLive()">TRACKING STARTEN \u2192</button>
</div>

<!-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 LIVE \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 -->
<div class="screen hidden" id="screenLive">
  <div class="live-header">
    <div class="live-logo">GIP<span>FEL</span></div>
    <div class="pill"><div class="dot" id="gpsDot"></div><span id="gpsLabel">GPS SUCHE</span></div>
    <div class="pill" id="recPill" style="display:none"><div class="dot rec"></div><span>REC</span></div>
  </div>

  <div class="live-scroll">
    <div class="speed-block">
      <div class="speed-label">AKTUELLE GESCHWINDIGKEIT</div>
      <div class="speed-row">
        <div class="speed-num" id="liveSpeed">0</div>
        <div class="speed-sidestack">
          <span class="speed-unit">KM/H</span>
          <div class="speed-maxlive">MAX: <strong id="liveMax">0</strong> km/h</div>
        </div>
      </div>
      <div class="tape-row">
        <div class="tape-track"><div class="tape-fill" id="speedTape"></div></div>
        <div class="tape-label" id="tapeLabel">0 km/h</div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-box"><div class="lbl">Zeit</div><div class="val" id="liveTimer">0:00</div></div>
      <div class="stat-box"><div class="lbl">Distanz</div><div class="val" id="liveDist">0</div><div class="unt" id="liveDistU">m</div></div>
      <div class="stat-box"><div class="lbl">H\u00f6he</div><div class="val" id="liveAlt">\u2014</div><div class="unt">m</div></div>
      <div class="stat-box"><div class="lbl">\u00d8 Speed</div><div class="val" id="liveAvg">0</div><div class="unt">km/h</div></div>
    </div>

    <div class="sensor-row">
      <div class="chip">\ud83d\udccd \u00b1<strong id="sAcc">\u2014</strong>m</div>
      <div class="chip">\ud83e\udded <strong id="sHead">\u2014</strong></div>
      <div class="chip">\ud83d\udcd0 <strong id="sTilt">\u2014</strong>\u00b0</div>
      <div class="chip">\ud83d\udd0b <strong id="sBat">\u2014</strong></div>
      <div class="chip">\u2b07\ufe0f -<strong id="sDes">0</strong>m</div>
      <div class="chip">\u2b06\ufe0f +<strong id="sAsc">0</strong>m</div>
    </div>

    <div class="map-block">
      <div class="inner-label">GPS TRACK</div>
      <div class="map-no-data" id="mapNoData">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.35"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="9" opacity="0.5"/></svg>
        GPS WARTEN...
      </div>
      <canvas id="liveMap"></canvas>
    </div>

    <div class="chart-block">
      <div class="inner-label" style="background:transparent">H\u00d6HENPROFIL</div>
      <canvas id="liveAlt"></canvas>
    </div>
  </div>

  <div class="live-controls">
    <button class="btn-ctrl primary" id="btnStart" onclick="startTracking()">\u25b6 START</button>
    <button class="btn-ctrl secondary" id="btnPause" onclick="togglePause()" style="display:none">\u23f8 PAUSE</button>
    <button class="btn-ctrl success" id="btnFinish" onclick="finishRun()" style="display:none">\u2713 FERTIG & ANALYSE</button>
  </div>
</div>

<!-- \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 ANALYSIS \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 -->
<div class="screen hidden" id="screenAnalysis">
  <div class="ana-header">
    <button class="btn-back" onclick="gotoLiveBack()">\u2190 LIVE</button>
    <div class="ana-title">ANALYSE</div>
    <div class="ana-badge" id="anaBadge">RUN #1</div>
  </div>

  <div class="ana-scroll">
    <div class="hero-stats">
      <div class="hstat spd"><div class="lbl">Top Speed</div><div class="big" id="aTopSpd">\u2014<span class="unit">km/h</span></div><div class="sub" id="aTopSub"></div></div>
      <div class="hstat avg"><div class="lbl">\u00d8 Geschwindigkeit</div><div class="big" id="aAvgSpd">\u2014<span class="unit">km/h</span></div><div class="sub" id="aAvgSub"></div></div>
      <div class="hstat dst"><div class="lbl">Distanz</div><div class="big" id="aDist">\u2014</div><div class="sub" id="aDistSub"></div></div>
      <div class="hstat alt"><div class="lbl">H\u00f6henmeter \u2193</div><div class="big" id="aDes">\u2014<span class="unit">m</span></div><div class="sub" id="aDesSub"></div></div>
    </div>

    <div class="sec">GPS TRACK \u2014 NACH GESCHWINDIGKEIT EINGEF\u00c4RBT</div>
    <div class="ana-map">
      <canvas id="anaMap" style="height:260px"></canvas>
      <div class="map-legend">
        <div class="leg"><div class="legdot" style="background:#34b4d4"></div>Langsam</div>
        <div class="leg"><div class="legdot" style="background:#4ade80"></div>Mittel</div>
        <div class="leg"><div class="legdot" style="background:#ff6b35"></div>Schnell</div>
        <div class="leg"><div class="legdot" style="background:white"></div>Start/Ende</div>
      </div>
    </div>

    <div class="sec">GESCHWINDIGKEIT \u00dcBER ZEIT</div>
    <div class="ana-chart">
      <div class="chart-head"><div class="ctitle">Speed</div><div class="cval" id="cSpdRange">\u2014</div></div>
      <canvas id="anaSpd" style="height:130px"></canvas>
    </div>

    <div class="sec">H\u00d6HENPROFIL</div>
    <div class="ana-chart">
      <div class="chart-head"><div class="ctitle">H\u00f6he</div><div class="cval" id="cAltRange">\u2014</div></div>
      <canvas id="anaAlt" style="height:130px"></canvas>
    </div>

    <div class="sec">GESCHWINDIGKEITSVERTEILUNG</div>
    <div class="dtable"><div class="dist-bars" id="speedDist"></div></div>

    <div class="sec">VOLLST\u00c4NDIGE DATEN</div>
    <div class="dtable" id="fullTable"></div>

    <div class="sec">ACHIEVEMENTS</div>
    <div class="ach-grid" id="achGrid"></div>

    <div class="sec">GPS DETAILS</div>
    <div class="dtable" id="gpsTable"></div>

    <div class="sec">ROHDATA EXPORT</div>
    <div class="dtable">
      <div class="drow"><span class="dk">GPS Punkte (JSON)</span><button onclick="exportGPX()" style="background:rgba(52,180,212,0.15);border:1px solid rgba(52,180,212,0.3);color:var(--glacier);padding:6px 14px;border-radius:8px;font-family:'DM Mono';font-size:11px;cursor:pointer;letter-spacing:1px">EXPORT</button></div>
    </div>
  </div>
</div>

<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// STATE
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
const S = {
  tracking: false, paused: false,
  positions: [], altitudes: [], speeds: [],
  startTime: null, timerInterval: null, watchId: null,
  maxSpeed: 0, totalDist: 0, totalDescent: 0, totalAscent: 0,
  prevAlt: null, runCount: 0, gpsReady: false,
  orient: { beta: 0, alpha: 0 }, battery: null
};

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// NAVIGATION
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function gotoLive() {
  show('screenLive');
  if (!S.gpsReady) initSensors();
}

function gotoLiveBack() {
  show('screenLive');
}

function gotoAnalysis() {
  show('screenAnalysis');
  setTimeout(buildAnalysis, 60);
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// SENSORS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
async function initSensors() {
  // Battery API
  try {
    const bat = await navigator.getBattery?.();
    if (bat) {
      S.battery = bat;
      const upd = () => { el('sBat').textContent = Math.round(bat.level*100)+'%'+(bat.charging?'\u26a1':''); };
      bat.addEventListener('levelchange', upd);
      bat.addEventListener('chargingchange', upd);
      upd();
    }
  } catch(e) {}

  // DeviceOrientation
  if (window.DeviceOrientationEvent) {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      try { await DeviceOrientationEvent.requestPermission(); } catch(e){}
    }
    window.addEventListener('deviceorientation', e => {
      S.orient = e;
      el('sTilt').textContent = Math.round(Math.abs(e.beta || 0));
      if (e.alpha != null) el('sHead').textContent = Math.round(e.alpha) + '\u00b0';
    }, { passive: true });
  }

  // GPS
  if (!navigator.geolocation) { alert('GPS nicht verf\u00fcgbar auf diesem Ger\u00e4t.'); return; }

  el('gpsDot').className = 'dot warn';
  el('gpsLabel').textContent = 'GPS SUCHE';

  S.watchId = navigator.geolocation.watchPosition(onPos, onPosErr, {
    enableHighAccuracy: true, timeout: 15000, maximumAge: 0
  });

  // Wake Lock
  try {
    if ('wakeLock' in navigator) navigator.wakeLock.request('screen');
  } catch(e){}

  S.gpsReady = true;
}

function onPos(pos) {
  const c = pos.coords;
  el('sAcc').textContent = Math.round(c.accuracy);

  if (c.accuracy <= 20) {
    el('gpsDot').className = 'dot gps';
    el('gpsLabel').textContent = 'GPS OK';
  } else {
    el('gpsDot').className = 'dot warn';
    el('gpsLabel').textContent = 'GPS SCHWACH';
  }

  if (c.heading != null) el('sHead').textContent = Math.round(c.heading) + '\u00b0';

  const alt = c.altitude != null ? Math.round(c.altitude) : null;
  if (alt !== null) el('liveAlt').textContent = alt;

  if (!S.tracking || S.paused) return;

  // Speed calculation
  let kmh = 0;
  if (c.speed != null && c.speed >= 0) {
    kmh = c.speed * 3.6;
  } else if (S.positions.length > 0) {
    const prev = S.positions[S.positions.length-1];
    const d = haversine(prev.lat, prev.lon, c.latitude, c.longitude);
    const dt = (pos.timestamp - prev.t) / 1000;
    if (dt > 0.5) kmh = (d / dt) * 3.6;
  }
  kmh = Math.max(0, Math.min(300, kmh));

  // UI
  el('liveSpeed').textContent = Math.round(kmh);
  const pct = Math.min(kmh / 120 * 100, 100);
  el('speedTape').style.width = pct + '%';
  el('tapeLabel').textContent = Math.round(kmh) + ' km/h';
  if (kmh > 80) el('liveSpeed').style.color = 'var(--summit)';
  else if (kmh > 50) el('liveSpeed').style.color = 'var(--yellow)';
  else el('liveSpeed').style.color = 'white';

  if (kmh > S.maxSpeed) {
    S.maxSpeed = kmh;
    el('liveMax').textContent = Math.round(kmh);
  }

  S.speeds.push({ t: pos.timestamp, v: kmh });

  // Altitude
  if (alt !== null) {
    S.altitudes.push({ t: pos.timestamp, v: alt });
    if (S.prevAlt !== null) {
      const diff = alt - S.prevAlt;
      if (diff < 0) { S.totalDescent += Math.abs(diff); el('sDes').textContent = Math.round(S.totalDescent); }
      if (diff > 0) { S.totalAscent += diff; el('sAsc').textContent = Math.round(S.totalAscent); }
    }
    S.prevAlt = alt;
  }

  // Distance
  if (S.positions.length > 0) {
    const prev = S.positions[S.positions.length-1];
    const d = haversine(prev.lat, prev.lon, c.latitude, c.longitude);
    if (d < 300) S.totalDist += d;
  }
  if (S.totalDist >= 1000) {
    el('liveDist').textContent = (S.totalDist/1000).toFixed(2);
    el('liveDistU').textContent = 'km';
  } else {
    el('liveDist').textContent = Math.round(S.totalDist);
    el('liveDistU').textContent = 'm';
  }

  // Avg speed
  if (S.speeds.length > 0) {
    el('liveAvg').textContent = Math.round(S.speeds.reduce((a,b)=>a+b.v,0)/S.speeds.length);
  }

  S.positions.push({ lat: c.latitude, lon: c.longitude, alt, spd: kmh, head: c.heading, acc: c.accuracy, t: pos.timestamp });

  el('mapNoData').style.display = 'none';
  redrawLiveMap();
  redrawLiveAlt();
}

function onPosErr(e) {
  el('gpsDot').className = 'dot';
  el('gpsLabel').textContent = 'GPS FEHLER';
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// TRACKING CONTROLS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function startTracking() {
  S.tracking = true; S.paused = false;
  S.startTime = Date.now();
  S.positions = []; S.altitudes = []; S.speeds = [];
  S.maxSpeed = 0; S.totalDist = 0; S.totalDescent = 0; S.totalAscent = 0;
  S.prevAlt = null;

  el('btnStart').style.display = 'none';
  el('btnPause').style.display = 'flex';
  el('btnFinish').style.display = 'flex';
  el('recPill').style.display = 'flex';

  S.timerInterval = setInterval(() => {
    if (S.paused) return;
    const e = Date.now() - S.startTime;
    const m = Math.floor(e/60000), s = Math.floor((e%60000)/1000);
    el('liveTimer').textContent = m + ':' + (s+'').padStart(2,'0');
  }, 500);
}

function togglePause() {
  S.paused = !S.paused;
  el('btnPause').textContent = S.paused ? '\u25b6 WEITER' : '\u23f8 PAUSE';
}

function finishRun() {
  S.tracking = false; S.paused = false;
  clearInterval(S.timerInterval);
  S.runCount++;
  el('btnStart').style.display = 'flex';
  el('btnPause').style.display = 'none';
  el('btnFinish').style.display = 'none';
  el('recPill').style.display = 'none';
  gotoAnalysis();
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// LIVE CANVAS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function redrawLiveMap() { drawMap(el('liveMap'), S.positions, 195, false); }
function redrawLiveAlt() { drawAlt(el('liveAlt'), S.altitudes, 88, '#34b4d4', 'rgba(52,180,212,0.15)'); }

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// ANALYSIS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function buildAnalysis() {
  const pts = S.positions, spds = S.speeds, alts = S.altitudes;
  const dur = S.startTime ? Date.now() - S.startTime : 0;
  const m = Math.floor(dur/60000), s = Math.floor((dur%60000)/1000);
  const tStr = m+':'+(s+'').padStart(2,'0');

  el('anaBadge').textContent = 'RUN #' + S.runCount;

  const topSpd = Math.round(S.maxSpeed);
  const avgSpd = spds.length ? Math.round(spds.reduce((a,b)=>a+b.v,0)/spds.length) : 0;
  const minSpd = spds.length ? Math.round(Math.min(...spds.map(s=>s.v))) : 0;

  el('aTopSpd').innerHTML = topSpd+'<span class="unit">km/h</span>';
  el('aTopSub').textContent = 'Dein Rekord dieser Abfahrt';
  el('aAvgSpd').innerHTML = avgSpd+'<span class="unit">km/h</span>';
  el('aAvgSub').textContent = '\u00fcber '+tStr+' Fahrzeit';
  const dStr = S.totalDist >= 1000 ? (S.totalDist/1000).toFixed(2)+'<span class="unit">km</span>' : Math.round(S.totalDist)+'<span class="unit">m</span>';
  el('aDist').innerHTML = dStr;
  el('aDistSub').textContent = S.positions.length + ' GPS Punkte';
  el('aDes').innerHTML = Math.round(S.totalDescent)+'<span class="unit">m</span>';
  el('aDesSub').textContent = '\u2191 ' + Math.round(S.totalAscent) + 'm aufgestiegen';

  drawMap(el('anaMap'), pts, 260, true);
  drawSpeedChart(el('anaSpd'), spds);
  drawAlt(el('anaAlt'), alts, 130, '#fbbf24', 'rgba(251,191,36,0.12)');
  buildSpeedDist(spds);
  buildFullTable(dur, tStr, pts, spds, alts, minSpd);
  buildAchievements(topSpd, avgSpd, S.totalDist, S.totalDescent, tStr, pts.length);
  buildGPSTable(pts);
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// DRAWING
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function setupCanvas(canvas, height) {
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth;
  canvas.width = W * dpr;
  canvas.height = height * dpr;
  canvas.style.height = height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  return { ctx, W, H: height };
}

function drawMap(canvas, pts, height, analysis) {
  const { ctx, W, H } = setupCanvas(canvas, height);
  ctx.clearRect(0, 0, W, H);

  // Background grid
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 0.5;
  for (let i=1;i<5;i++) {
    ctx.beginPath(); ctx.moveTo(W*i/5,0); ctx.lineTo(W*i/5,H); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0,H*i/5); ctx.lineTo(W,H*i/5); ctx.stroke();
  }

  if (pts.length < 2) return;

  const lats = pts.map(p=>
